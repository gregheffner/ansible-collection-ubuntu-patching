---
# Kubernetes node reboot and maintenance tasks
- name: Drain the node
  command: kubectl drain {{ inventory_hostname }} --ignore-daemonsets --delete-emptydir-data --force --timeout=300s {{ '--insecure-skip-tls-verify' if k8s_skip_tls_verify | default(false) else '' }}
  delegate_to: "{{ k8_primary_node | default('k8-primary') }}"
  register: drain_result
  failed_when: drain_result.rc != 0
  environment:
    KUBECONFIG: "{{ kubeconfig_path | default('/home/huey/.kube/config') }}"
    KUBERNETES_MASTER: "{{ k8s_api_server | default('') }}"

- name: Reboot the node
  shell: systemctl reboot
  async: 1
  poll: 0
  ignore_errors: true
  become: true

- name: Wait for SSH to come back
  wait_for_connection:
    delay: "{{ reboot_delay | default(30) }}"
    timeout: "{{ reboot_timeout | default(600) }}"

- name: Ensure /tmp directory has correct permissions
  become: true
  file:
    path: /tmp
    state: directory
    mode: '1777'

- name: Wait for node to be ready
  command: kubectl get node {{ inventory_hostname }} -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}' {{ '--insecure-skip-tls-verify' if k8s_skip_tls_verify | default(false) else '' }}
  delegate_to: "{{ k8_primary_node | default('k8-primary') }}"
  register: node_status
  until: node_status.stdout == "True"
  retries: "{{ node_ready_retries | default(30) }}"
  delay: "{{ node_ready_delay | default(10) }}"
  environment:
    KUBECONFIG: "{{ kubeconfig_path | default('/home/huey/.kube/config') }}"
    KUBERNETES_MASTER: "{{ k8s_api_server | default('') }}"

- name: Uncordon the node
  command: kubectl uncordon {{ inventory_hostname }} {{ '--insecure-skip-tls-verify' if k8s_skip_tls_verify | default(false) else '' }}
  delegate_to: "{{ k8_primary_node | default('k8-primary') }}"
  register: uncordon_result
  environment:
    KUBECONFIG: "{{ kubeconfig_path | default('/home/huey/.kube/config') }}"
    KUBERNETES_MASTER: "{{ k8s_api_server | default('') }}"
  failed_when: uncordon_result.rc != 0

- name: Fix /tmp permissions on Ansible controller
  become: true
  file:
    path: /tmp
    state: directory
    mode: '1777'
  delegate_to: localhost
  run_once: true