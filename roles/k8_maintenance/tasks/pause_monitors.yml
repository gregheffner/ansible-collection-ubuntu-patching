---
# Pause Datadog monitors and synthetic tests
- name: Get current timestamp
  setup:
    filter: ansible_date_time
  delegate_to: localhost

- name: Get Datadog API key from 1Password
  shell: /home/linuxbrew/.linuxbrew/bin/op read "op://Secure APIs/vault_dd_api_key/password"
  register: dd_api_key_result
  no_log: true
  delegate_to: localhost
  environment:
    OP_SERVICE_ACCOUNT_TOKEN: "{{ lookup('env', 'OP_SERVICE_ACCOUNT_TOKEN') }}"

- name: Get Datadog Application key from 1Password
  shell: /home/linuxbrew/.linuxbrew/bin/op read "op://Secure APIs/vault_dd_app_key/password"
  register: dd_app_key_result
  no_log: true
  delegate_to: localhost
  environment:
    OP_SERVICE_ACCOUNT_TOKEN: "{{ lookup('env', 'OP_SERVICE_ACCOUNT_TOKEN') }}"

- name: Set API key variables
  set_fact:
    datadog_api_key: "{{ dd_api_key_result.stdout }}"
    datadog_app_key: "{{ dd_app_key_result.stdout }}"
  no_log: true
  delegate_to: localhost

- name: Get all monitors
  uri:
    url: "https://api.us5.datadoghq.com/api/v1/monitor"
    method: GET
    headers:
      DD-API-KEY: "{{ datadog_api_key }}"
      DD-APPLICATION-KEY: "{{ datadog_app_key }}"
    return_content: yes
    status_code: 200
  register: monitors_response
  delegate_to: localhost

- name: Display number of monitors found
  debug:
- name: Display number of monitors found
  debug:
    msg: "Found {{ monitors_response.json | length }} monitors to pause"
  delegate_to: localhost
  when: 
    - pause_monitors_enabled | default(false)
    - datadog_api_key is defined
    - datadog_app_key is defined
    - monitors_response is defined
    - monitors_response.json is defined
    - not ansible_check_mode

- name: Calculate pause end time
  set_fact:
    pause_end_time: "{{ ansible_date_time.epoch | int + (pause_duration | default(3600)) }}"
  delegate_to: localhost
  when:
    - pause_monitors_enabled | default(false)
    - not ansible_check_mode

- name: Pause each monitor
  uri:
    url: "https://api.us5.datadoghq.com/api/v1/monitor/{{ item.id }}/mute"
    method: POST
    headers:
      DD-API-KEY: "{{ datadog_api_key }}"
      DD-APPLICATION-KEY: "{{ datadog_app_key }}"
      Content-Type: "application/json"
    body_format: json
    body:
      end: "{{ pause_end_time }}"
      message: "Muted during K8s maintenance - automated by Ansible"
    status_code: 200
  loop: "{{ monitors_response.json }}"
  when: 
    - pause_monitors_enabled | default(false)
    - datadog_api_key is defined
    - datadog_app_key is defined
    - monitors_response is defined
    - monitors_response.json is defined
    - not ansible_check_mode
  delegate_to: localhost

- name: Get all synthetic tests
  uri:
    url: "https://api.us5.datadoghq.com/api/v1/synthetics/tests"
    method: GET
    headers:
      DD-API-KEY: "{{ datadog_api_key }}"
      DD-APPLICATION-KEY: "{{ datadog_app_key }}"
    return_content: yes
    status_code: 200
  register: synthetics_response
  delegate_to: localhost
  when:
    - pause_monitors_enabled | default(false)
    - datadog_api_key is defined
    - datadog_app_key is defined
    - not ansible_check_mode

- name: Display number of synthetic tests found
  debug:
    msg: "Found {{ synthetics_response.json.tests | length }} synthetic tests to pause"
  delegate_to: localhost
  when:
    - pause_monitors_enabled | default(false)
    - datadog_api_key is defined
    - datadog_app_key is defined
    - synthetics_response is defined
    - synthetics_response.json is defined
    - synthetics_response.json.tests is defined
    - not ansible_check_mode

- name: Pause each synthetic test
  uri:
    url: "https://api.us5.datadoghq.com/api/v1/synthetics/tests/{{ item.public_id }}/status"
    method: PUT
    headers:
      DD-API-KEY: "{{ datadog_api_key }}"
      DD-APPLICATION-KEY: "{{ datadog_app_key }}"
      Content-Type: "application/json"
    body_format: json
    body:
      new_status: "paused"
    status_code: 200
  loop: "{{ synthetics_response.json.tests }}"
  when: 
    - pause_monitors_enabled | default(false)
    - datadog_api_key is defined
    - datadog_app_key is defined
    - synthetics_response is defined
    - synthetics_response.json is defined
    - synthetics_response.json.tests is defined
    - not ansible_check_mode
  delegate_to: localhost