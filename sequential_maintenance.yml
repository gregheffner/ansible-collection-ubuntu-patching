---
# Sequential Maintenance Playbook - K8s first, then Docker host
# This ensures K8s maintenance completes before touching the docker host

- name: Update Collection
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Update gregheffner.ubuntu_patching collection
      command: ansible-galaxy collection install gregheffner.ubuntu_patching --force
      delegate_to: localhost
      run_once: true
      register: collection_update
      changed_when: false

    - name: Log collection update to summary
      delegate_to: localhost
      run_once: true
      shell: |
        if [ -n "$GITHUB_STEP_SUMMARY" ]; then
          echo "## ðŸ”„ Collection Update" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Collection updated successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
      when: lookup('env', 'GITHUB_STEP_SUMMARY') != ""

- name: K8s Cluster Maintenance (Phase 1)
  hosts: k8s_cluster
  become: true
  serial: 1  # Process K8s nodes one at a time
  gather_facts: true
  
  vars:
    # K8s-specific variables
    perform_reboot: true
    update_docker: true
    pause_monitors_enabled: true
    pause_duration: 3600  # 1 hour
    k8_primary_node: "k8-primary"
    reboot_delay: 30
    k8s_reboot_timeout: 600
    node_ready_retries: 30
    node_ready_delay: 10

  pre_tasks:
    - name: Announce K8s maintenance start
      delegate_to: localhost
      run_once: true
      shell: echo "::notice::ðŸ”§ Phase 1 - Starting K8s Cluster Maintenance"
      when: lookup('env', 'GITHUB_STEP_SUMMARY') != ""

    - name: Display K8s maintenance start
      debug:
        msg: |
          === PHASE 1: K8s CLUSTER MAINTENANCE ===
          Starting maintenance on: {{ inventory_hostname }}
          Node role: {{ 'Primary' if inventory_hostname == k8_primary_node else 'Worker' }}
          Time: {{ ansible_date_time.iso8601 }}

  roles:
    - role: gregheffner.ubuntu_patching.k8_maintenance
      tags: ['k8s_maintenance', 'kubernetes']

  post_tasks:
    - name: K8s maintenance completion
      debug:
        msg: |
          K8s maintenance completed on: {{ inventory_hostname }}
          Phase 1 complete for this node
          Time: {{ ansible_date_time.iso8601 }}
    
    - name: Generate K8s maintenance summary
      delegate_to: localhost
      run_once: true
      shell: |
        echo "::notice::âœ… Phase 1 Complete - K8s Cluster Updated"
        if [ -n "$GITHUB_STEP_SUMMARY" ]; then
          {
            echo "## ðŸ”§ K8s Cluster Maintenance Complete"
            echo ""
            echo "**Phase 1 Results:**"
            echo "- âœ… All K8s nodes updated"
            echo "- ðŸ”„ Nodes rebooted and rejoined cluster"
            echo "- â±ï¸ Completed at: $(date -Iseconds)"
            echo ""
            echo "**Nodes Processed:**"
            {% for host in groups['k8s_cluster'] %}
            echo "- ðŸ–¥ï¸ {{ host }}"
            {% endfor %}
            echo ""
            echo "---"
          } >> $GITHUB_STEP_SUMMARY
        fi
      when: lookup('env', 'GITHUB_STEP_SUMMARY') != ""

- name: Docker Host Maintenance (Phase 2) 
  hosts: dockerhost
  become: true
  gather_facts: true
  
  vars:
    # Docker host variables
    perform_reboot: true
    update_docker: true
    pause_monitors_enabled: false  # No K8s monitors on docker host
    perform_dist_upgrade: false    # Conservative for automation
    cleanup_packages: true
    reboot_method: "modern"
    reboot_timeout: 600
    connect_timeout: 20

  pre_tasks:
    - name: Fix /tmp permissions before maintenance
      become: true
      command: systemctl start fix-tmp-perms.service
      ignore_errors: true

    - name: Announce Docker host maintenance start
      delegate_to: localhost
      shell: echo "::notice::ðŸ³ Phase 2 - Starting Docker Host Maintenance"
      when: lookup('env', 'GITHUB_STEP_SUMMARY') != ""

    - name: Display docker maintenance start
      debug:
        msg: |
          === PHASE 2: DOCKER HOST MAINTENANCE ===
          Starting maintenance on: {{ inventory_hostname }}
          K8s cluster maintenance is now complete
          Time: {{ ansible_date_time.iso8601 }}

  roles:
    - role: gregheffner.ubuntu_patching.ubuntu_update
      tags: ['ubuntu_update', 'system_packages']

  post_tasks:
    - name: Final completion status
      debug:
        msg: |
          === SEQUENTIAL MAINTENANCE COMPLETE ===
          Docker host maintenance completed on: {{ inventory_hostname }}
          All maintenance phases finished successfully
          Time: {{ ansible_date_time.iso8601 }}
    
    - name: Generate final maintenance summary
      delegate_to: localhost
      shell: |
        echo "::notice::âœ… Phase 2 Complete - Docker Host Updated"
        echo "::notice::ðŸŽ‰ All Infrastructure Maintenance Complete!"
        if [ -n "$GITHUB_STEP_SUMMARY" ]; then
          {
            echo "## ðŸ³ Docker Host Maintenance Complete"
            echo ""
            echo "**Phase 2 Results:**"
            echo "- âœ… System packages updated"
            echo "- ðŸ‹ Docker updated"
            echo "- ðŸ”„ System rebooted"
            echo "- â±ï¸ Completed at: $(date -Iseconds)"
            echo ""
            echo "**Host Processed:**"
            echo "- ðŸ–¥ï¸ {{ inventory_hostname }}"
            echo ""
            echo "---"
            echo ""
            echo "# ðŸŽ‰ All Maintenance Complete!"
            echo ""
            echo "| Phase | Status |"
            echo "|-------|--------|"
            echo "| K8s Cluster | âœ… Complete |"
            echo "| Docker Host | âœ… Complete |"
            echo ""
            echo "**Next maintenance:** Scheduled for next Saturday"
          } >> $GITHUB_STEP_SUMMARY
        fi
      when: lookup('env', 'GITHUB_STEP_SUMMARY') != ""