---
name: Debug SSH Access

on:
  workflow_dispatch:

jobs:
  debug-ssh:
    runs-on: self-hosted
    steps:
      - name: Debug environment
        run: |
          echo "=== ENVIRONMENT DEBUG ==="
          echo "User: $(whoami)"
          echo "Home: $HOME"
          echo "Current dir: $(pwd)"
          echo "SSH_AUTH_SOCK: $SSH_AUTH_SOCK"
          echo ""
          
          echo "=== SSH DIRECTORY ==="
          ls -la ~/.ssh/ || echo "No .ssh directory"
          echo ""
          
          echo "=== SSH AGENT STATUS ==="
          ssh-add -l 2>&1 || echo "No SSH agent or keys"
          echo ""
          
          echo "=== SSH KEY FILES ==="
          ls -la ~/.ssh/id_* 2>/dev/null || echo "No SSH key files found"
          echo ""
          
          echo "=== TEST DIRECT SSH ==="
          ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no k8-primary "echo 'SSH Success!'" 2>&1 || echo "SSH Failed"
          echo ""
          
          echo "=== TEST WITH SSH KEY ==="
          ssh -i ~/.ssh/id_rsa -o ConnectTimeout=5 -o StrictHostKeyChecking=no k8-primary "echo 'SSH with key works!'" 2>&1 || echo "SSH with key failed"
          echo ""
          
          echo "=== TEST ANSIBLE CONNECTIVITY ==="
          ansible k8s_cluster -m ping --one-line 2>&1 || echo "Ansible connectivity failed"
          echo ""
          
          echo "=== TEST DOCKERHOST CONNECTIVITY ==="
          ansible dockerhost -m ping --one-line 2>&1 || echo "Dockerhost connectivity failed"