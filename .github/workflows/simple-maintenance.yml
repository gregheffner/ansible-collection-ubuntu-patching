---
name: Simple Sequential Maintenance

on:
  schedule:
    # Every Saturday at 6:00 AM UTC
    - cron: '0 6 * * 6'
  
  # Allow manual runs
  workflow_dispatch:

jobs:
  sequential-maintenance:
    name: K8s â†’ Docker Sequential Maintenance
    runs-on: self-hosted
    timeout-minutes: 180  # 3 hours
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Sequential Maintenance
        run: |
          echo "ðŸš€ Starting Sequential Infrastructure Maintenance"
          echo "Phase 1: K8s Cluster â†’ Phase 2: Docker Host"
          
          # Set environment
          export OP_SERVICE_ACCOUNT_TOKEN=$(cat /home/ansible/scripts/op-signin/op_token)
          
          # Install collection
          ansible-galaxy collection install gregheffner.ubuntu_patching --force
          
          # Run sequential maintenance playbook
          ansible-playbook sequential_maintenance.yml \
            -i inventory/hosts.ini \
            --extra-vars "k8s_skip_tls_verify=true" \
            -v
          
          # Log completion
          echo "[$(date)] Sequential maintenance completed successfully" >> /mnt/QNAP/backuplogs/ansible-automation.log
          echo "âœ… Sequential maintenance completed!"